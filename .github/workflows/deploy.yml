name: Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types: [closed]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '23'
          cache: 'npm'

      - name: Install dependencies
        run: npm i

      # 1. Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ˜Ğ¯ Ğ’Ğ•Ğ Ğ¡Ğ˜Ğ˜ - ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
      - name: Generate version info
        run: |
          echo "DEPLOY_VERSION=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV
          echo "BUILD_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV
          echo "Generated version: $(date +%Y%m%d_%H%M%S)"

      - name: Create environment file
        run: |
          echo "BASE_URL=${{ secrets.BASE_URL }}" >> .env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          echo "NEXT_PUBLIC_STRAPI_URL=${{ secrets.NEXT_PUBLIC_STRAPI_URL }}" >> .env
          echo "NEXT_PUBLIC_STRAPI_API_KEY=${{ secrets.NEXT_PUBLIC_STRAPI_API_KEY }}" >> .env
          echo "NEXT_PUBLIC_RESEND_API_KEY=${{ secrets.NEXT_PUBLIC_RESEND_API_KEY }}" >> .env
          echo "NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}" >> .env
          echo "NEXT_PUBLIC_GOOGLE_MAP_ID=${{ secrets.NEXT_PUBLIC_GOOGLE_MAP_ID }}" >> .env
          # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ² Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Next.js
          echo "NEXT_PUBLIC_APP_VERSION=${{ env.DEPLOY_VERSION }}" >> .env
          echo "NEXT_PUBLIC_BUILD_HASH=${{ env.BUILD_HASH }}" >> .env

      - name: Build project
        run: npm run build

      # 2. Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ’Ğ•Ğ Ğ¡Ğ˜Ğ˜ Ğ’ Ğ¡Ğ‘ĞĞ ĞšĞ£ - ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ğ¾ÑĞ»Ğµ Ğ±Ğ¸Ğ»Ğ´Ğ°
      - name: Add version info to build
        run: |
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ Ğ²ĞµÑ€ÑĞ¸Ğ¸
          cat > ./out/version.json << EOF
          {
            "version": "${{ env.DEPLOY_VERSION }}",
            "buildHash": "${{ env.BUILD_HASH }}",
            "buildNumber": "${{ env.BUILD_NUMBER }}",
            "buildDate": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}"
          }
          EOF
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ JavaScript Ñ„Ğ°Ğ¹Ğ» Ñ Ğ²ĞµÑ€ÑĞ¸ĞµĞ¹
          echo "window.APP_VERSION = '${{ env.DEPLOY_VERSION }}';" > ./out/version.js
          echo "window.BUILD_HASH = '${{ env.BUILD_HASH }}';" >> ./out/version.js
          echo "window.BUILD_DATE = '$(date -u +"%Y-%m-%dT%H:%M:%SZ")';" >> ./out/version.js
          
          echo "Version files created successfully"

      - name: Verify build output
        run: |
          if [ ! -d "./out" ]; then
            echo "Error: ./out directory not found after build"
            exit 1
          fi
          echo "Build output contents:"
          ls -la ./out
          echo "Version info:"
          cat ./out/version.json

      # 3. Ğ”Ğ•ĞŸĞ›ĞĞ™ Ğ¡ Ğ’Ğ•Ğ Ğ¡Ğ˜Ğ•Ğ™ - Ñ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ¾Ğ¹ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¾Ğ¹ ĞºĞµÑˆĞ°
      - name: Deploy via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.SFTP_SERVER }}
          port: ${{ secrets.SFTP_PORT }}
          username: ${{ secrets.SFTP_USERNAME }}
          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          local_path: './out/*'
          remote_path: '/web/htdocs/www.finest-tobacco.com/home/www/'
          sftp_only: true

      # 4. ĞĞ§Ğ˜Ğ¡Ğ¢ĞšĞ ĞšĞ•Ğ¨Ğ Ğ¡ Ğ’Ğ•Ğ Ğ¡Ğ˜ĞĞĞ˜Ğ ĞĞ’ĞĞĞ˜Ğ•Ğœ
      - name: Clear server cache and add cache headers
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key
          
          ssh -i /tmp/ssh_key -p 2222 -o StrictHostKeyChecking=no \
          b992k7w-ssh@finest-tobacco.com "
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ° ĞºĞµÑˆĞ°
          find ~/domains/*/public_html -name '*.html' -exec touch {} \; 2>/dev/null || true
          find ~/domains/*/public_html -name '*.css' -exec touch {} \; 2>/dev/null || true
          find ~/domains/*/public_html -name '*.js' -exec touch {} \; 2>/dev/null || true
          
          echo 'Deploy completed at: $(date)'
          echo 'Deployed version: ${{ env.DEPLOY_VERSION }}'
          echo 'Build hash: ${{ env.BUILD_HASH }}'
          echo 'Latest files:'
          ls -lat ~/domains/*/public_html/ 2>/dev/null | head -10 || ls -lat ~/public_html/ 2>/dev/null | head -10 || echo 'Could not list files'
          "
          
          rm /tmp/ssh_key

      # 5. Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞĞ¯ Ğ˜ĞĞ¤ĞĞ ĞœĞĞ¦Ğ˜Ğ¯ Ğ Ğ”Ğ•ĞŸĞ›ĞĞ•
      - name: Deployment summary
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "ğŸ“¦ Version: ${{ env.DEPLOY_VERSION }}"
          echo "ğŸ”¨ Build Hash: ${{ env.BUILD_HASH }}"
          echo "ğŸ—ï¸ Build Number: ${{ env.BUILD_NUMBER }}"
          echo "â° Deploy Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ğŸŒ Site: https://www.finest-tobacco.com"
          echo "ğŸ“Š Version Info: https://www.finest-tobacco.com/version.json"